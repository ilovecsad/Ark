#include "KernelInject.h"
#include "emunProcess.h"
#include "exapi.h"

BOOLEAN g_bHideInject = FALSE;

const UCHAR HookCode64[] = {
	0x50,                                                         // push       rax
	0x51,                                                         // push       rcx
	0x52,                                                         // push       rdx
	0x41, 0x50,                                                   // push       r8
	0x41, 0x51,                                                   // push       r9
	0x41, 0x53,                                                   // push       r11
	0x48, 0x83, 0xEC, 0x38,                                       // sub         rsp,38h
	0x48, 0x8B, 0x05, 0, 0, 0, 0,                                 // mov         rax,qword ptr [fnHookPort]        offset+16
	0x4C, 0x8D, 0x44, 0x24, 0x48,                                 // lea         r8,[rsp + 48h]
	0x48, 0x89, 0x44, 0x24, 0x50,                                 // mov         qword ptr [rsp+50h],rax  
	0x48, 0x8D, 0x54, 0x24, 0x50,                                 // lea         rdx,[rsp + 50h]
	0x48, 0x8D, 0x44, 0x24, 0x40,                                 // lea         rax,[rsp + 40h]
	0x48, 0xC7, 0x44, 0x24, 0x48,                                 // mov         qword ptr[rsp + 48h],5
	5, 0, 0, 0,
	0x41, 0xB9, 0x40, 0, 0, 0,                                     // mov         r9d,40h
	0x48, 0x89, 0x44, 0x24, 0x20,                                 // mov         qword ptr[rsp + 20h],rax
	0x48, 0x83, 0xC9, 0xFF,                                       // or          rcx, 0FFFFFFFFFFFFFFFFh
	0xE8, 0, 0, 0, 0,                                             // call                   fnProtectVirtualMemory                 offset +65
	0x8B, 0x05, 0, 0, 0, 0,                                       // mov         eax,dword ptr[fnOriCode]                offset+71
	0x4C, 0x8D, 0x44, 0x24, 0x48,                                // lea         r8,[rsp + 48h]
	0x48, 0x8B, 0x15, 0, 0, 0, 0,                                 // mov         rdx,qword ptr[fnHookPort]         offset+83
	0x48, 0x83, 0xC9, 0xFF,                                        // or          rcx, 0FFFFFFFFFFFFFFFFh
	0x89, 0x02,                                                   // mov         dword ptr[rdx],eax
	0x0F, 0xB6, 0x05, 0, 0, 0, 0,                                  // movzx       eax,byte ptr[fnOriCode+4]        offset+96
	0x88, 0x42, 0x04,                                               // mov         byte ptr[rdx + 4],al
	0x48, 0x8D, 0x44, 0x24, 0x40,                                  // lea         rax,[rsp + 40h]
	0x44, 0x8B, 0x4C, 0x24, 0x40,                                  // mov         r9d,dword ptr[rsp + 40h]
	0x48, 0x8D, 0x54, 0x24, 0x50,                                  // lea         rdx,[rsp + 50h]
	0x48, 0x89, 0x44, 0x24, 0x20,                                   // mov         qword ptr [rsp+20h],rax
	0xE8, 0, 0, 0, 0,                                              // call        fnProtectVirtualMemory                offset +124
	0x4C, 0x8D, 0x0D, 0, 0, 0, 0,                                   // lea         r9,qword ptr [pModuleHandle]  offset+131
	0x33, 0xD2,                                                    // xor         edx,edx
	0x4C, 0x8D, 0x05, 0, 0, 0, 0,                                    // lea         r8,qword ptr [pModuleName]         offset+140                        
	0x33, 0xC9,                                                    // xor         ecx,ecx
	0xE8, 0, 0, 0, 0,                                             // call        fnLdrLoadDll                                         offset +147
	0x48, 0x83, 0xC4, 0x38,                                       // add         rsp,38h
	0x41, 0x5B,                                                     // pop        r11
	0x41, 0x59,                                                     // pop        r9
	0x41, 0x58,                                                     // pop        r8
	0x5A,                                                           // pop        rdx
	0x59,                                                          // pop        rcx
	0x58,                                                          // pop        rax
	0xE9, 0, 0, 0, 0,                                             // jmp        OriFunc offset+165
	0xCC,                                                         // padding
};

const UCHAR HookCode32[] = {
	0x55,									// push        ebp
	0x8B, 0xEC,								// mov         ebp,esp
	0x83, 0xEC, 0x0C,						// sub         esp,0Ch
	0xA1, 0, 0, 0, 0,						// mov         eax,dword ptr[fnHookFunc] //offset +7
	0x89, 0x45, 0xF4,						// mov         dword ptr[ebp-0Ch],eax
	0x8D, 0x45, 0xFC,						// lea         eax,[ebp - 4]
	0x50,									// push        eax
	0x6A, 0x40,								// push        40h
	0x8D, 0x45, 0xF8,						// lea         eax,[ebp - 8]
	0xC7, 0x45, 0xF8, 5, 0, 0, 0,			// mov         dword ptr[ebp - 8],5
	0x50,									// push        eax
	0x8D, 0x45, 0xF4,						// lea         eax,[ebp - 0Ch]
	0x50,									// push        eax
	0x6A, 0xFF,								// push        0FFFFFFFFh
	0xE8, 0, 0, 0, 0,						// call        NtProtectVirtualMemory //offset +38
	0x8B, 0x0D, 0, 0, 0, 0,					// mov         ecx,dword ptr ds : [fnHookFunc] //offset + 44
	0xA1, 0, 0, 0, 0,						// mov         eax,dword ptr ds : [fnOriCode] //offset + 49
	0x89, 0x01,								// mov         dword ptr[ecx],eax
	0xA0, 0, 0, 0, 0,						// mov         al,byte ptr ds : [fnOriCode+4] //offset +56
	0x88, 0x41, 0x04,						// mov         byte ptr[ecx + 4],al
	0x8D, 0x45, 0xFC,						// lea         eax,[ebp-4]
	0x50,									// push        eax
	0xFF, 0x75, 0xFC,						// push        dword ptr[ebp-4]
	0x8D, 0x45, 0xF8,						// lea         eax,[ebp - 8]
	0x50,									// push        eax
	0x8D, 0x45, 0xF4,						// lea         eax,[ebp - 0Ch]
	0x50,									// push        eax
	0x6A, 0xFF,								// push        0FFFFFFFFh
	0xE8, 0, 0, 0, 0,                       // call        NtProtectVirtualMemory //offset +81
	0x68, 0, 0, 0, 0,                       // push        ModuleHandle           //offset +86
	0x68, 0, 0, 0, 0,                       // push        ModuleFileName         //offset +91
	0x6A, 0,                                // push        0  
	0x6A, 0,                                // push        0
	0xE8, 0, 0, 0, 0,                       // call        LdrLoadDll              //offset +100
	0x8B, 0xE5,								// mov         esp,ebp
	0x5D,									// pop         ebp
	0xE9, 0, 0, 0, 0,						// jmp								   //offset+108
	0xCC									// padding
	//0x55,                                                               // push       ebp
	//0x8B, 0xEC,                                                         // mov     ebp, esp
	//0x83, 0xEC, 0x14,                                                   // sub     esp, 14h
	//0xA1, 0x34, 0x40, 0x40, 0x00,                                       // mov     eax, fnHookFunc32
	//0x89, 0x45, 0xFC,                                                   // mov     [ebp+Base], eax
	//0xC7, 0x45, 0xF4, 0x05, 0x00, 0x00, 0x00,                           // mov     [ebp+Len], 5
	//0xC7, 0x45, 0xF0, 0x00, 0x00, 0x00, 0x00,                           // mov     [ebp+fnProtectVirtualMemory32], 0
	//0xC7, 0x45, 0xEC, 0x00, 0x00, 0x00, 0x00,                           // mov     [ebp+fnLdrLoadDll], 0
	//0x8D, 0x4D, 0xF8,                                                   // lea     ecx, [ebp+OldProtect]
	//0x51,                                                               // push    ecx             ; unsigned int * 
	//0x6A, 0x40,                                                         // push    40h             ; unsigned int
	//0x8D, 0x55, 0xF4,                                                   // lea     edx, [ebp+Len]
	//0x52,                                                               // push    edx
	//0x8D, 0x45, 0xFC,                                                   //lea     eax, [ebp + Base]
	//0x50,                                                               // push    eax
	//0x6A, 0xFF,                                                         // push    0FFFFFFFFh
	//0xFF, 0x55, 0xF0,                                                   // call    [ebp+fnProtectVirtualMemory32]
	//0x8B, 0x4D, 0xFC,                                                   // mov     ecx, [ebp+Base]
	//                     
	//0x8B, 0x15, 0x6C, 0x40, 0x40, 0x00,                                 // mov     edx, fnOriCode
	//0x89,0x11,                                                          //  mov     [ecx], edx
	//0xA0, 0x70, 0x40, 0x40, 0x00,                                       // mov     al, byte_404070
	//0x88, 0x41, 0x04,                                                   // mov     [ecx+4], al
	//0x8D, 0x4D, 0xF8,                                                   //lea     ecx, [ebp+OldProtect]
	//0x51,                                                               //push    ecx             ; unsigned int *
	//0x8B, 0x55, 0xF8,                                                   // mov     edx, [ebp+OldProtect]
	//0x52,                                                               // push    edx
	//0x8D, 0x45, 0xF4,                                                   // lea     eax, [ebp+Len]
	//0x50,                                                               // push    eax
	//0x8D, 0x4D, 0xFC,                                                   // lea     ecx, [ebp+Base]
	//0x51,                                                               //push    ecx
	//0x6A, 0xFF,                                                         // push    0FFFFFFFFh
	//0xFF, 0x55, 0xF0,                                                   // call    [ebp+fnProtectVirtualMemory32]                      
	//0x68, 0x7C, 0x40, 0x40, 0x00,                                       // push    offset ModuleHandle ; void **
	//0x68, 0x74, 0x40, 0x40, 0x00,                                       // push    offset ModuleName ; _UNICODE_STRING *
	//0x6A, 0x00,                                                         // push    0               ; unsigned int
	//0x6A, 0x00,                                                         //push    0               ; wchar_t
	//0xFF, 0x55, 0xEC,                                                   // call    [ebp+fnLdrLoadDll]
	//0x8B, 0xE5,                                                         //mov     esp, ebp
	//0x5D,                                                               // pop     ebp
	//0xE9,0x00,0x00,0x00,0x00,                                            // jmp Original
	//0xCC                                                                 //padding
};
UCHAR HideCode64[] = {
	 0x50 ,0x51 ,0x52 ,0x41 ,0x50 ,0x41 ,0x51 ,0x41 ,0x53 ,
	 0x48 ,0x83 ,0xEC ,0x38 ,0x48 ,0x8D ,0x0D ,
	 0x56 ,0x06 ,0x00 ,0x00 ,  /***/
	 0xE8 ,
	 0x26,0x00 ,0x00 ,0x00   /***/
	,0x48 ,0x83 ,0xC4 ,0x38 ,0x41 ,0x5B ,0x41 ,0x59 ,0x41 ,0x58 ,0x5A ,0x59 ,0x58 ,

	0x4c ,0x8b ,0xd1 , /*mov r10,rcx*/
	0xb8 ,0xba ,0x01,0x00 ,0x00 , /*mov eax,000001ba*/
	0xe9 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0xCC

,0x40 ,0x55 ,0x53 ,0x56 ,0x57 ,0x41 ,0x54 ,0x41 ,0x55 ,0x41 ,0x56 ,0x41 ,0x57 ,0x48 ,0x8D ,0x6C ,0x24 ,0xE8 ,0x48 ,0x81 ,0xEC ,0x18 ,0x01 ,0x00 ,0x00 ,0x33 ,0xC0 ,0x48 ,0x8D ,0x51
,0x6A ,0x4C ,0x8B ,0xF1 ,0x48 ,0x89 ,0x45 ,0x88 ,0x33 ,0xDB ,0x48 ,0x89 ,0x45 ,0x90 ,0x48 ,0x8D ,0x4D ,0x88 ,0x48 ,0x89 ,0x5D ,0x60 ,0x48 ,0x89 ,0x5D ,0x70 ,0x48 ,0x89 ,0x45 ,0x98
,0x48 ,0x89 ,0x45 ,0xA0 ,0x41 ,0xFF ,0x56 ,0x50 ,0x89 ,0x5C ,0x24 ,0x50 ,0x48 ,0x8D ,0x45 ,0x88 ,0x48 ,0x89 ,0x5C ,0x24 ,0x48 ,0x4C ,0x8D ,0x4D ,0x98 ,0xC7 ,0x44 ,0x24 ,0x40 ,0x20
,0x00 ,0x00 ,0x00 ,0x4C ,0x8D ,0x45 ,0xE0 ,0xC7 ,0x44 ,0x24 ,0x38 ,0x01 ,0x00 ,0x00 ,0x00 ,0x48 ,0x8D ,0x4D ,0x70 ,0xC7 ,0x44 ,0x24 ,0x30 ,0x01 ,0x00 ,0x00 ,0x00 ,0x0F ,0x57 ,0xC0
,0xC7 ,0x44 ,0x24 ,0x28 ,0x80 ,0x00 ,0x00 ,0x00 ,0xBA ,0x00 ,0x00 ,0x10 ,0x80 ,0x48 ,0x89 ,0x5C ,0x24 ,0x20 ,0xC7 ,0x45 ,0xE0 ,0x30 ,0x00 ,0x00 ,0x00 ,0x48 ,0x89 ,0x5D ,0xE8 ,0x48
,0x89 ,0x45 ,0xF0 ,0xC7 ,0x45 ,0xF8 ,0x40 ,0x00 ,0x00 ,0x00 ,0xF3 ,0x0F ,0x7F ,0x45 ,0x00 ,0x41 ,0xFF ,0x56 ,0x48 ,0x85 ,0xC0 ,0x0F ,0x88 ,0x64 ,0x05 ,0x00 ,0x00 ,0x48 ,0x8B ,0x4D
,0x70 ,0x44 ,0x8D ,0x4B ,0x18 ,0x33 ,0xC0 ,0xC7 ,0x44 ,0x24 ,0x20 ,0x05 ,0x00 ,0x00 ,0x00 ,0x4C ,0x8D ,0x45 ,0xB8 ,0x48 ,0x89 ,0x45 ,0xB8 ,0x48 ,0x8D ,0x55 ,0x98 ,0x48 ,0x89 ,0x45
,0xC0 ,0x48 ,0x89 ,0x45 ,0xC8 ,0x41 ,0xFF ,0x56 ,0x58 ,0x48 ,0x8B ,0x45 ,0x70 ,0x4C ,0x8D ,0x45 ,0xE0 ,0x8B ,0x75 ,0xC0 ,0x48 ,0x8D ,0x4D ,0x68 ,0x48 ,0x89 ,0x44 ,0x24 ,0x30 ,0x45
,0x33 ,0xC9 ,0xC7 ,0x44 ,0x24 ,0x28 ,0x00 ,0x00 ,0x00 ,0x04 ,0xBA ,0x1F ,0x00 ,0x0F ,0x00 ,0xC7 ,0x44 ,0x24 ,0x20 ,0x02 ,0x00 ,0x00 ,0x00 ,0x48 ,0x89 ,0x5D ,0x68 ,0x48 ,0x89 ,0x74
,0x24 ,0x78 ,0x48 ,0x89 ,0x5D ,0xF0 ,0x41 ,0xFF ,0x56 ,0x30 ,0x85 ,0xC0 ,0x0F ,0x88 ,0xF5 ,0x04 ,0x00 ,0x00 ,0x48 ,0x8B ,0x4D ,0x68 ,0x48 ,0x8D ,0x44 ,0x24 ,0x60 ,0xC7 ,0x44 ,0x24
,0x48 ,0x02 ,0x00 ,0x00 ,0x00 ,0x4C ,0x8D ,0x44 ,0x24 ,0x70 ,0xC7 ,0x44 ,0x24 ,0x40 ,0x00 ,0x00 ,0x40 ,0x00 ,0x48 ,0x8D ,0x53 ,0xFF ,0xC7 ,0x44 ,0x24 ,0x38 ,0x01 ,0x00 ,0x00 ,0x00
,0x45 ,0x33 ,0xC9 ,0x48 ,0x89 ,0x44 ,0x24 ,0x30 ,0x48 ,0x89 ,0x5C ,0x24 ,0x28 ,0x48 ,0x89 ,0x74 ,0x24 ,0x20 ,0x48 ,0x89 ,0x5C ,0x24 ,0x70 ,0x48 ,0x89 ,0x5C ,0x24 ,0x60 ,0x41 ,0xFF
,0x56 ,0x38 ,0x48 ,0x8B ,0x4D ,0x68 ,0x41 ,0xFF ,0x56 ,0x60 ,0x48 ,0x8B ,0x4D ,0x70 ,0x41 ,0xFF ,0x56 ,0x60 ,0x48 ,0x89 ,0x5D ,0x68 ,0x85 ,0xC0 ,0x0F ,0x88 ,0x8F ,0x04 ,0x00 ,0x00
,0x48 ,0x8B ,0x7C ,0x24 ,0x70 ,0x48 ,0x83 ,0xFE ,0x40 ,0x0F ,0x86 ,0x77 ,0x04 ,0x00 ,0x00 ,0xB8 ,0x4D ,0x5A ,0x00 ,0x00 ,0x66 ,0x39 ,0x07 ,0x0F ,0x85 ,0x69 ,0x04 ,0x00 ,0x00 ,0x48
,0x63 ,0x4F ,0x3C ,0x48 ,0x8D ,0x81 ,0x08 ,0x01 ,0x00 ,0x00 ,0x48 ,0x3B ,0xF0 ,0x0F ,0x82 ,0x55 ,0x04 ,0x00 ,0x00 ,0x81 ,0x3C ,0x39 ,0x50 ,0x45 ,0x00 ,0x00 ,0x4C ,0x8D ,0x3C ,0x39
,0x4C ,0x89 ,0x7D ,0x80 ,0x0F ,0x85 ,0x40 ,0x04 ,0x00 ,0x00 ,0x41 ,0x0F ,0xB7 ,0x47 ,0x16 ,0xB9 ,0x02 ,0x20 ,0x00 ,0x00 ,0x66 ,0x23 ,0xC1 ,0x66 ,0x3B ,0xC1 ,0x0F ,0x85 ,0x2A ,0x04
,0x00 ,0x00 ,0xB8 ,0xF0 ,0x00 ,0x00 ,0x00 ,0x66 ,0x41 ,0x39 ,0x47 ,0x14 ,0x0F ,0x85 ,0x1A ,0x04 ,0x00 ,0x00 ,0x45 ,0x0F ,0xB7 ,0x4F ,0x06 ,0x4D ,0x85 ,0xC9 ,0x74 ,0x2D ,0x8B ,0xD3
,0x49 ,0x8D ,0x8F ,0x18 ,0x01 ,0x00 ,0x00 ,0x66 ,0x66 ,0x66 ,0x0F ,0x1F ,0x84 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x8B ,0x41 ,0x04 ,0x03 ,0x01 ,0x3B ,0xC6 ,0x0F ,0x87 ,0xEF ,0x03 ,0x00
,0x00 ,0x48 ,0xFF ,0xC2 ,0x48 ,0x83 ,0xC1 ,0x28 ,0x49 ,0x3B ,0xD1 ,0x7C ,0xE7 ,0x45 ,0x8B ,0x57 ,0x38 ,0x33 ,0xD2 ,0x41 ,0x8B ,0x47 ,0x54 ,0xFF ,0xC8 ,0x41 ,0x03 ,0xC2 ,0x41 ,0xF7
,0xF2 ,0x44 ,0x8B ,0xC0 ,0x45 ,0x0F ,0xAF ,0xC2 ,0x4D ,0x85 ,0xC9 ,0x74 ,0x3B ,0x4D ,0x8D ,0x9F ,0x18 ,0x01 ,0x00 ,0x00 ,0x66 ,0x90 ,0x41 ,0x8B ,0x53 ,0xF8 ,0x41 ,0x8D ,0x42 ,0xFF
,0x41 ,0x39 ,0x13 ,0x41 ,0x0F ,0x4F ,0x13 ,0x41 ,0x03 ,0x53 ,0xFC ,0x4D ,0x8D ,0x5B ,0x28 ,0x03 ,0xC2 ,0x33 ,0xD2 ,0x41 ,0xF7 ,0xF2 ,0x41 ,0x0F ,0xAF ,0xC2 ,0x44 ,0x3B ,0xC0 ,0x41
,0x0F ,0x4D ,0xC0 ,0x44 ,0x8B ,0xC0 ,0x49 ,0x83 ,0xE9 ,0x01 ,0x75 ,0xCE ,0x45 ,0x85 ,0xC0 ,0x0F ,0x84 ,0x81 ,0x03 ,0x00 ,0x00 ,0x49 ,0x63 ,0xF0 ,0x4C ,0x8D ,0x4C ,0x24 ,0x78 ,0x48
,0x89 ,0x5C ,0x24 ,0x30 ,0x48 ,0x8D ,0x4D ,0x68 ,0xC7 ,0x44 ,0x24 ,0x28 ,0x00 ,0x00 ,0x00 ,0x08 ,0x45 ,0x33 ,0xC0 ,0xBA ,0x1F ,0x00 ,0x0F ,0x00 ,0x48 ,0x89 ,0x74 ,0x24 ,0x78 ,0xC7
,0x44 ,0x24 ,0x20 ,0x40 ,0x00 ,0x00 ,0x00 ,0x41 ,0xFF ,0x56 ,0x30 ,0x85 ,0xC0 ,0x0F ,0x88 ,0x50 ,0x03 ,0x00 ,0x00 ,0x41 ,0x38 ,0x5E ,0x68 ,0x4C ,0x8D ,0x45 ,0x60 ,0x48 ,0x8B ,0x4D
,0x68 ,0xB8 ,0x00 ,0x00 ,0x00 ,0x70 ,0xC7 ,0x44 ,0x24 ,0x48 ,0x40 ,0x00 ,0x00 ,0x00 ,0x48 ,0x0F ,0x45 ,0xC3 ,0x89 ,0x5C ,0x24 ,0x40 ,0x45 ,0x33 ,0xC9 ,0xC7 ,0x44 ,0x24 ,0x38 ,0x02
,0x00 ,0x00 ,0x00 ,0x48 ,0x89 ,0x45 ,0x60 ,0x48 ,0x8D ,0x44 ,0x24 ,0x60 ,0x48 ,0x89 ,0x44 ,0x24 ,0x30 ,0x48 ,0x89 ,0x5C ,0x24 ,0x28 ,0x49 ,0x8D ,0x51 ,0xFF ,0x48 ,0x89 ,0x74 ,0x24
,0x20 ,0x48 ,0x89 ,0x5C ,0x24 ,0x60 ,0x41 ,0xFF ,0x56 ,0x38 ,0x85 ,0xC0 ,0x0F ,0x88 ,0xF7 ,0x02 ,0x00 ,0x00 ,0x4C ,0x8B ,0x45 ,0x60 ,0x4D ,0x85 ,0xC0 ,0x0F ,0x84 ,0xE5 ,0x02 ,0x00
,0x00 ,0x45 ,0x0F ,0xB7 ,0x4F ,0x06 ,0x41 ,0x8B ,0x47 ,0x54 ,0x43 ,0x8D ,0x0C ,0x89 ,0x8D ,0x0C ,0xC8 ,0x48 ,0x63 ,0xD1 ,0x85 ,0xC9 ,0x7E ,0x27 ,0x48 ,0x8B ,0xCB ,0x66 ,0x66 ,0x66
,0x0F ,0x1F ,0x84 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x0F ,0xB6 ,0x04 ,0x39 ,0x42 ,0x88 ,0x04 ,0x01 ,0x48 ,0xFF ,0xC1 ,0x4C ,0x8B ,0x45 ,0x60 ,0x48 ,0x3B ,0xCA ,0x7C ,0xEC ,0x45 ,0x0F
,0xB7 ,0x4F ,0x06 ,0x44 ,0x8B ,0xD3 ,0x66 ,0x41 ,0x3B ,0xD9 ,0x73 ,0x5B ,0x49 ,0x8D ,0x97 ,0x18 ,0x01 ,0x00 ,0x00 ,0x0F ,0x1F ,0x80 ,0x00 ,0x00 ,0x00 ,0x00 ,0x8B ,0x42 ,0xFC ,0x85
,0xC0 ,0x74 ,0x35 ,0x8B ,0x0A ,0x85 ,0xC9 ,0x74 ,0x2F ,0x4D ,0x8D ,0x0C ,0x00 ,0x48 ,0x8B ,0xC3 ,0x0F ,0x1F ,0x40 ,0x00 ,0x0F ,0x1F ,0x84 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x8B ,0x4A
,0x04 ,0x48 ,0x03 ,0xC8 ,0x0F ,0xB6 ,0x0C ,0x39 ,0x42 ,0x88 ,0x0C ,0x08 ,0x48 ,0xFF ,0xC0 ,0x8B ,0x0A ,0x48 ,0x3B ,0xC1 ,0x72 ,0xE8 ,0x4C ,0x8B ,0x45 ,0x60 ,0x41 ,0x0F ,0xB7 ,0x47
,0x06 ,0x41 ,0xFF ,0xC2 ,0x48 ,0x83 ,0xC2 ,0x28 ,0x44 ,0x3B ,0xD0 ,0x7C ,0xB3 ,0x41 ,0x8B ,0x87 ,0xB0 ,0x00 ,0x00 ,0x00 ,0x85 ,0xC0 ,0x0F ,0x84 ,0xB1 ,0x00 ,0x00 ,0x00 ,0x41 ,0x39
,0x9F ,0xB4 ,0x00 ,0x00 ,0x00 ,0x0F ,0x86 ,0xA4 ,0x00 ,0x00 ,0x00 ,0x41 ,0x8B ,0x0C ,0x00 ,0x4D ,0x8D ,0x14 ,0x00 ,0x45 ,0x8B ,0x4A ,0x04 ,0x49 ,0x8B ,0xF8 ,0x49 ,0x2B ,0x7F ,0x30
,0x41 ,0x03 ,0xC9 ,0x0F ,0x84 ,0x88 ,0x00 ,0x00 ,0x00 ,0xBE ,0x00 ,0xA0 ,0x00 ,0x00 ,0x41 ,0xBC ,0x00 ,0xF0 ,0x00 ,0x00 ,0x41 ,0xBD ,0x00 ,0x30 ,0x00 ,0x00 ,0x66 ,0x66 ,0x0F ,0x1F
,0x84 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x41 ,0x8B ,0xC1 ,0x48 ,0x8B ,0xD3 ,0x48 ,0x83 ,0xE8 ,0x08 ,0x48 ,0xD1 ,0xE8 ,0x4C ,0x63 ,0xD8 ,0x85 ,0xC0 ,0x7E ,0x47 ,0x0F ,0x1F ,0x40 ,0x00
,0x0F ,0x1F ,0x84 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x45 ,0x0F ,0xB7 ,0x4C ,0x52 ,0x08 ,0x41 ,0x0F ,0xB7 ,0xC1 ,0x66 ,0x41 ,0x23 ,0xC4 ,0x66 ,0x41 ,0x3B ,0xC5 ,0x74 ,0x05 ,0x66 ,0x3B
,0xC6 ,0x75 ,0x16 ,0x41 ,0x8B ,0x0A ,0x41 ,0x81 ,0xE1 ,0xFF ,0x0F ,0x00 ,0x00 ,0x4B ,0x8D ,0x04 ,0x08 ,0x48 ,0x01 ,0x3C ,0x01 ,0x4C ,0x8B ,0x45 ,0x60 ,0x48 ,0xFF ,0xC2 ,0x49 ,0x3B
,0xD3 ,0x7C ,0xC9 ,0x45 ,0x8B ,0x4A ,0x04 ,0x41 ,0x8B ,0xC1 ,0x4C ,0x03 ,0xD0 ,0x41 ,0x8B ,0x0A ,0x45 ,0x8B ,0x4A ,0x04 ,0x41 ,0x03 ,0xC9 ,0x75 ,0x93 ,0x41 ,0x8B ,0x87 ,0x90 ,0x00
,0x00 ,0x00 ,0x48 ,0x85 ,0xC0 ,0x0F ,0x84 ,0x73 ,0x01 ,0x00 ,0x00 ,0x4E ,0x8D ,0x2C ,0x00 ,0x42 ,0x8B ,0x04 ,0x00 ,0x85 ,0xC0 ,0x0F ,0x84 ,0x06 ,0x01 ,0x00 ,0x00 ,0x0F ,0x1F ,0x00
,0x41 ,0x8B ,0x55 ,0x0C ,0x48 ,0x8D ,0x4D ,0xA8 ,0x45 ,0x8B ,0x65 ,0x10 ,0x49 ,0x03 ,0xD0 ,0x44 ,0x8B ,0xF8 ,0x4D ,0x03 ,0xE0 ,0x4D ,0x03 ,0xF8 ,0x48 ,0x89 ,0x5D ,0x78 ,0x41 ,0xFF
,0x56 ,0x18 ,0x41 ,0xB0 ,0x01 ,0x48 ,0x8D ,0x55 ,0xA8 ,0x48 ,0x8D ,0x4D ,0xD0 ,0x41 ,0xFF ,0x56 ,0x20 ,0x4C ,0x8D ,0x4D ,0x78 ,0x33 ,0xD2 ,0x4C ,0x8D ,0x45 ,0xD0 ,0x33 ,0xC9 ,0x41
,0xFF ,0x56 ,0x10 ,0x48 ,0x8D ,0x4D ,0xD0 ,0x41 ,0xFF ,0x56 ,0x28 ,0x48 ,0x8B ,0x4D ,0x78 ,0x48 ,0x85 ,0xC9 ,0x0F ,0x84 ,0x08 ,0x01 ,0x00 ,0x00 ,0x49 ,0x8B ,0x07 ,0x48 ,0x8B ,0xFB
,0x48 ,0x85 ,0xC0 ,0x0F ,0x84 ,0x88 ,0x00 ,0x00 ,0x00 ,0x49 ,0x8B ,0xD7 ,0x48 ,0x8B ,0xF3 ,0x0F ,0x1F ,0x80 ,0x00 ,0x00 ,0x00 ,0x00 ,0x4C ,0x8B ,0x02 ,0x48 ,0x89 ,0x5C ,0x24 ,0x68
,0x48 ,0x85 ,0xC0 ,0x79 ,0x12 ,0x66 ,0x45 ,0x85 ,0xC0 ,0x0F ,0x84 ,0xD5 ,0x00 ,0x00 ,0x00 ,0x45 ,0x0F ,0xB7 ,0xC0 ,0x33 ,0xD2 ,0xEB ,0x24 ,0x4C ,0x8B ,0x45 ,0x60 ,0x49 ,0x8D ,0x50
,0x02 ,0x48 ,0x03 ,0xD0 ,0x0F ,0x84 ,0xC0 ,0x00 ,0x00 ,0x00 ,0x48 ,0x8D ,0x4D ,0xA8 ,0x41 ,0xFF ,0x56 ,0x18 ,0x48 ,0x8B ,0x4D ,0x78 ,0x48 ,0x8D ,0x55 ,0xA8 ,0x45 ,0x33 ,0xC0 ,0x4C
,0x8D ,0x4C ,0x24 ,0x68 ,0x41 ,0xFF ,0x16 ,0x48 ,0x8B ,0x44 ,0x24 ,0x68 ,0x48 ,0x85 ,0xC0 ,0x0F ,0x84 ,0x93 ,0x00 ,0x00 ,0x00 ,0x48 ,0xFF ,0xC7 ,0x4A ,0x89 ,0x04 ,0x26 ,0x48 ,0x8D
,0x34 ,0xFD ,0x00 ,0x00 ,0x00 ,0x00 ,0x4A ,0x8B ,0x04 ,0x3E ,0x4A ,0x8D ,0x14 ,0x3E ,0x48 ,0x85 ,0xC0 ,0x74 ,0x06 ,0x48 ,0x8B ,0x4D ,0x78 ,0xEB ,0x85 ,0x41 ,0x8B ,0x45 ,0x14 ,0x49
,0x83 ,0xC5 ,0x14 ,0x4C ,0x8B ,0x45 ,0x60 ,0x85 ,0xC0 ,0x0F ,0x85 ,0x01 ,0xFF ,0xFF ,0xFF ,0x4C ,0x8B ,0x7D ,0x80 ,0x41 ,0x8B ,0x7F ,0x28 ,0x49 ,0x03 ,0xF8 ,0x41 ,0x39 ,0x5F ,0x54
,0x76 ,0x27 ,0x48 ,0x8B ,0xC3 ,0x0F ,0x1F ,0x40 ,0x00 ,0x66 ,0x0F ,0x1F ,0x84 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x42 ,0xC6 ,0x04 ,0x00 ,0xDD ,0x48 ,0x8D ,0x40 ,0x01 ,0xFF ,0xC3 ,0x41
,0x3B ,0x5F ,0x54 ,0x73 ,0x06 ,0x4C ,0x8B ,0x45 ,0x60 ,0xEB ,0xE9 ,0x48 ,0x8B ,0x54 ,0x24 ,0x70 ,0x48 ,0xC7 ,0xC1 ,0xFF ,0xFF ,0xFF ,0xFF ,0x41 ,0xFF ,0x56 ,0x40 ,0x48 ,0x8B ,0x4D
,0x68 ,0x41 ,0xFF ,0x56 ,0x60 ,0x4C ,0x8B ,0x45 ,0x60 ,0xBA ,0x01 ,0x00 ,0x00 ,0x00 ,0x33 ,0xC9 ,0xFF ,0xD7 ,0x4C ,0x8B ,0x45 ,0x60 ,0x49 ,0x8B ,0xC0 ,0xEB ,0x02 ,0x33 ,0xC0 ,0x48
,0x81 ,0xC4 ,0x18 ,0x01 ,0x00 ,0x00 ,0x41 ,0x5F ,0x41 ,0x5E ,0x41 ,0x5D ,0x41 ,0x5C ,0x5F ,0x5E ,0x5B ,0x5D ,0xC3
};

UCHAR HideCode32[] = {
	 0x60 ,0x9C ,0xB8 ,

	 0x00 ,0x00 ,0x00 ,0x00 ,/******/

	 0x05 ,0xEC ,0x05 ,0x00 ,0x00 ,0x50 ,0xE8 ,0x16 ,0x00 ,0x00 ,0x00 ,0x9D ,0x61 ,
	 
	 0xb8 ,0xba,0x01 ,0x02 ,0x00 

	 ,0xe9 ,0x90 ,0x90 ,0x90 ,0x90 
	,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90 ,0x90
	,0x55 ,0x8B ,0xEC ,0x83 ,0xE4 ,0xF8 ,0x81 ,0xEC ,0x8C ,0x00 ,0x00 ,0x00 ,0x53 ,0x8B ,0x5D ,0x08 ,0x0F ,0x57 ,0xC0 ,0x56 ,0x57 ,0xC7 ,0x44
	,0x24 ,0x10 ,0x00 ,0x00 ,0x00 ,0x00 ,0x8D ,0x43 ,0x36 ,0xC7 ,0x44 ,0x24 ,0x20 ,0x00 ,0x00 ,0x00 ,0x00 ,0x50 ,0x8D ,0x44 ,0x24 ,0x54 ,0x66
	,0x0F ,0x13 ,0x44 ,0x24 ,0x54 ,0x50 ,0x8B ,0x43 ,0x28 ,0x66 ,0x0F ,0x13 ,0x44 ,0x24 ,0x60 ,0xFF ,0xD0 ,0x6A ,0x00 ,0x6A ,0x00 ,0x6A ,0x20
	,0x6A ,0x01 ,0x6A ,0x01 ,0x68 ,0x80 ,0x00 ,0x00 ,0x00 ,0x8D ,0x44 ,0x24 ,0x68 ,0xC7 ,0x84 ,0x24 ,0x80 ,0x00 ,0x00 ,0x00 ,0x18 ,0x00 ,0x00
	,0x00 ,0x89 ,0x84 ,0x24 ,0x88 ,0x00 ,0x00 ,0x00 ,0x8D ,0x44 ,0x24 ,0x70 ,0x6A ,0x00 ,0x50 ,0x8D ,0x84 ,0x24 ,0x88 ,0x00 ,0x00 ,0x00 ,0xC7
	,0x84 ,0x24 ,0x8C ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x50 ,0x68 ,0x00 ,0x00 ,0x10 ,0x80 ,0x8D ,0x44 ,0x24 ,0x48 ,0xC7 ,0x84 ,0x24
	,0x9C ,0x00 ,0x00 ,0x00 ,0x40 ,0x00 ,0x00 ,0x00 ,0x50 ,0x8B ,0x43 ,0x24 ,0xC7 ,0x84 ,0x24 ,0xA4 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00
	,0xC7 ,0x84 ,0x24 ,0xA8 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0xFF ,0xD0 ,0x85 ,0xC0 ,0x0F ,0x88 ,0x0E ,0x05 ,0x00 ,0x00 ,0x6A ,0x05
	,0x6A ,0x18 ,0x8D ,0x84 ,0x24 ,0x88 ,0x00 ,0x00 ,0x00 ,0x0F ,0x57 ,0xC0 ,0x50 ,0x8D ,0x44 ,0x24 ,0x64 ,0x66 ,0x0F ,0xD6 ,0x84 ,0x24 ,0x9C
	,0x00 ,0x00 ,0x00 ,0x50 ,0xFF ,0x74 ,0x24 ,0x30 ,0x8B ,0x43 ,0x2C ,0x0F ,0x11 ,0x84 ,0x24 ,0x94 ,0x00 ,0x00 ,0x00 ,0xFF ,0xD0 ,0xFF ,0x74
	,0x24 ,0x20 ,0x8B ,0xB4 ,0x24 ,0x8C ,0x00 ,0x00 ,0x00 ,0x8D ,0x44 ,0x24 ,0x6C ,0x68 ,0x00 ,0x00 ,0x00 ,0x04 ,0x6A ,0x02 ,0x6A ,0x00 ,0x50
	,0x68 ,0x1F ,0x00 ,0x0F ,0x00 ,0x8D ,0x44 ,0x24 ,0x48 ,0xC7 ,0x44 ,0x24 ,0x48 ,0x00 ,0x00 ,0x00 ,0x00 ,0x50 ,0x8B ,0x43 ,0x18 ,0x89 ,0x74
	,0x24 ,0x54 ,0xC7 ,0x44 ,0x24 ,0x58 ,0x00 ,0x00 ,0x00 ,0x00 ,0xC7 ,0x84 ,0x24 ,0x8C ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0x00 ,0xFF ,0xD0
	,0x85 ,0xC0 ,0x0F ,0x88 ,0x91 ,0x04 ,0x00 ,0x00 ,0x6A ,0x02 ,0x68 ,0x00 ,0x00 ,0x40 ,0x00 ,0x6A ,0x01 ,0x8D ,0x44 ,0x24 ,0x30 ,0xC7 ,0x44
	,0x24 ,0x34 ,0x00 ,0x00 ,0x00 ,0x00 ,0x50 ,0x6A ,0x00 ,0x56 ,0x6A ,0x00 ,0x8D ,0x44 ,0x24 ,0x44 ,0xC7 ,0x44 ,0x24 ,0x40 ,0x00 ,0x00 ,0x00
	,0x00 ,0x50 ,0x8B ,0x43 ,0x1C ,0x6A ,0xFF ,0xFF ,0x74 ,0x24 ,0x54 ,0xFF ,0xD0 ,0xFF ,0x74 ,0x24 ,0x30 ,0x8B ,0x43 ,0x30 ,0xFF ,0xD0 ,0xFF
	,0x74 ,0x24 ,0x20 ,0x8B ,0x43 ,0x30 ,0xFF ,0xD0 ,0xC7 ,0x44 ,0x24 ,0x30 ,0x00 ,0x00 ,0x00 ,0x00 ,0x85 ,0xC0 ,0x0F ,0x88 ,0x3C ,0x04 ,0x00
	,0x00 ,0x8B ,0x7C ,0x24 ,0x28 ,0x89 ,0x7C ,0x24 ,0x18 ,0x83 ,0xFE ,0x40 ,0x0F ,0x86 ,0x1C ,0x04 ,0x00 ,0x00 ,0xB8 ,0x4D ,0x5A ,0x00 ,0x00
	,0x66 ,0x39 ,0x07 ,0x0F ,0x85 ,0x0E ,0x04 ,0x00 ,0x00 ,0x8B ,0x4F ,0x3C ,0x8D ,0x81 ,0xF8 ,0x00 ,0x00 ,0x00 ,0x3B ,0xF0 ,0x0F ,0x82 ,0xFD
	,0x03 ,0x00 ,0x00 ,0x03 ,0xCF ,0x89 ,0x4C ,0x24 ,0x14 ,0x81 ,0x39 ,0x50 ,0x45 ,0x00 ,0x00 ,0x0F ,0x85 ,0xEB ,0x03 ,0x00 ,0x00 ,0x66 ,0x8B
	,0x41 ,0x16 ,0xBA ,0x02 ,0x20 ,0x00 ,0x00 ,0x66 ,0x23 ,0xC2 ,0x66 ,0x3B ,0xC2 ,0x0F ,0x85 ,0xD6 ,0x03 ,0x00 ,0x00 ,0xB8 ,0xE0 ,0x00 ,0x00
	,0x00 ,0x66 ,0x39 ,0x41 ,0x14 ,0x0F ,0x85 ,0xC7 ,0x03 ,0x00 ,0x00 ,0x0F ,0xB7 ,0x41 ,0x06 ,0x33 ,0xD2 ,0x89 ,0x44 ,0x24 ,0x0C ,0x85 ,0xC0
	,0x74 ,0x21 ,0x81 ,0xC1 ,0x08 ,0x01 ,0x00 ,0x00 ,0x8B ,0x41 ,0x04 ,0x03 ,0x01 ,0x3B ,0xC6 ,0x0F ,0x87 ,0xA6 ,0x03 ,0x00 ,0x00 ,0x42 ,0x83
	,0xC1 ,0x28 ,0x3B ,0x54 ,0x24 ,0x0C ,0x7C ,0xE9 ,0x8B ,0x4C ,0x24 ,0x14 ,0x8B ,0x44 ,0x24 ,0x14 ,0x33 ,0xD2 ,0x8B ,0x49 ,0x38 ,0x8B ,0x40
	,0x54 ,0x48 ,0x03 ,0xC1 ,0xF7 ,0xF1 ,0x8B ,0xF0 ,0x0F ,0xAF ,0xF1 ,0x83 ,0x7C ,0x24 ,0x0C ,0x00 ,0x76 ,0x44 ,0x8B ,0x54 ,0x24 ,0x14 ,0x8D
	,0xBA ,0x08 ,0x01 ,0x00 ,0x00 ,0xEB ,0x02 ,0x8B ,0xD3 ,0x8B ,0x4F ,0xF8 ,0x39 ,0x0F ,0x8B ,0x42 ,0x38 ,0x0F ,0x4F ,0x0F ,0x48 ,0x03 ,0x4F
	,0xFC ,0x8D ,0x7F ,0x28 ,0x8B ,0x5C ,0x24 ,0x14 ,0x03 ,0xC1 ,0x33 ,0xD2 ,0xF7 ,0x73 ,0x38 ,0x0F ,0xAF ,0x43 ,0x38 ,0x3B ,0xF0 ,0x0F ,0x4D
	,0xC6 ,0x83 ,0x6C ,0x24 ,0x0C ,0x01 ,0x8B ,0xF0 ,0x75 ,0xCF ,0x8B ,0x5D ,0x08 ,0x8B ,0x7C ,0x24 ,0x18 ,0x85 ,0xF6 ,0x0F ,0x84 ,0x2F ,0x03
	,0x00 ,0x00 ,0x6A ,0x00 ,0x68 ,0x00 ,0x00 ,0x00 ,0x08 ,0x6A ,0x40 ,0x8D ,0x44 ,0x24 ,0x44 ,0x89 ,0x74 ,0x24 ,0x44 ,0x50 ,0x6A ,0x00 ,0x68
	,0x1F ,0x00 ,0x0F ,0x00 ,0x8D ,0x44 ,0x24 ,0x48 ,0xC7 ,0x44 ,0x24 ,0x54 ,0x00 ,0x00 ,0x00 ,0x00 ,0x50 ,0x8B ,0x43 ,0x18 ,0xFF ,0xD0 ,0x85
	,0xC0 ,0x0F ,0x88 ,0x0B ,0x03 ,0x00 ,0x00 ,0x33 ,0xC9 ,0xB8 ,0x00 ,0x00 ,0x00 ,0x70 ,0x38 ,0x4B ,0x34 ,0x6A ,0x40 ,0x51 ,0x0F ,0x45 ,0xC1
	,0x89 ,0x4C ,0x24 ,0x2C ,0x6A ,0x02 ,0x89 ,0x44 ,0x24 ,0x1C ,0x8D ,0x44 ,0x24 ,0x30 ,0x50 ,0x51 ,0x56 ,0x51 ,0x8D ,0x44 ,0x24 ,0x2C ,0x50
	,0x8B ,0x43 ,0x1C ,0x6A ,0xFF ,0xFF ,0x74 ,0x24 ,0x54 ,0xFF ,0xD0 ,0x85 ,0xC0 ,0x0F ,0x88 ,0xD1 ,0x02 ,0x00 ,0x00 ,0x8B ,0x74 ,0x24 ,0x10
	,0x85 ,0xF6 ,0x0F ,0x84 ,0xBA ,0x02 ,0x00 ,0x00 ,0x8B ,0x44 ,0x24 ,0x14 ,0x0F ,0xB7 ,0x50 ,0x06 ,0x8B ,0xC2 ,0x8D ,0x0C ,0x80 ,0x8B ,0x44
	,0x24 ,0x14 ,0x8B ,0x40 ,0x54 ,0x8D ,0x04 ,0xC8 ,0x33 ,0xC9 ,0x89 ,0x44 ,0x24 ,0x18 ,0x8B ,0xC2 ,0x8B ,0x54 ,0x24 ,0x18 ,0x85 ,0xD2 ,0x7E
	,0x19 ,0x8A ,0x04 ,0x0F ,0x88 ,0x04 ,0x31 ,0x41 ,0x8B ,0x74 ,0x24 ,0x10 ,0x3B ,0xCA ,0x7C ,0xF1 ,0x8B ,0x54 ,0x24 ,0x14 ,0x0F ,0xB7 ,0x42
	,0x06 ,0xEB ,0x04 ,0x8B ,0x54 ,0x24 ,0x14 ,0x33 ,0xC9 ,0x89 ,0x4C ,0x24 ,0x0C ,0x89 ,0x4C ,0x24 ,0x18 ,0x66 ,0x3B ,0xC8 ,0x73 ,0x59 ,0x8B
	,0x5C ,0x24 ,0x14 ,0x81 ,0xC2 ,0x08 ,0x01 ,0x00 ,0x00 ,0x0F ,0x1F ,0x40 ,0x00 ,0x8B ,0x42 ,0xFC ,0x85 ,0xC0 ,0x74 ,0x31 ,0x83 ,0x3A ,0x00
	,0x74 ,0x2C ,0x03 ,0xC6 ,0x33 ,0xC9 ,0x89 ,0x44 ,0x24 ,0x18 ,0x39 ,0x0A ,0x76 ,0x1C ,0x8B ,0xF0 ,0x66 ,0x0F ,0x1F ,0x44 ,0x00 ,0x00 ,0x8B
	,0x42 ,0x04 ,0x03 ,0xC1 ,0x8A ,0x04 ,0x38 ,0x88 ,0x04 ,0x31 ,0x41 ,0x3B ,0x0A ,0x72 ,0xF0 ,0x8B ,0x74 ,0x24 ,0x10 ,0x8B ,0x4C ,0x24 ,0x0C
	,0x0F ,0xB7 ,0x43 ,0x06 ,0x41 ,0x83 ,0xC2 ,0x28 ,0x89 ,0x4C ,0x24 ,0x0C ,0x3B ,0xC8 ,0x7C ,0xB8 ,0x8B ,0x5D ,0x08 ,0x8B ,0x54 ,0x24 ,0x14
	,0x8B ,0x8A ,0xA0 ,0x00 ,0x00 ,0x00 ,0x85 ,0xC9 ,0x0F ,0x84 ,0x8D ,0x00 ,0x00 ,0x00 ,0x83 ,0xBA ,0xA4 ,0x00 ,0x00 ,0x00 ,0x00 ,0x0F ,0x86
	,0x80 ,0x00 ,0x00 ,0x00 ,0x8B ,0xC6 ,0x8D ,0x3C ,0x31 ,0x2B ,0x42 ,0x34 ,0x8B ,0x4F ,0x04 ,0x89 ,0x44 ,0x24 ,0x2C ,0x8B ,0x07 ,0x03 ,0xC1
	,0x74 ,0x6B ,0xC7 ,0x44 ,0x24 ,0x1C ,0x00 ,0x30 ,0x00 ,0x00 ,0xC7 ,0x44 ,0x24 ,0x0C ,0x00 ,0xA0 ,0x00 ,0x00 ,0x90 ,0x8D ,0x41 ,0xF8 ,0xBA
	,0x00 ,0x00 ,0x00 ,0x00 ,0xD1 ,0xE8 ,0x89 ,0x44 ,0x24 ,0x18 ,0x74 ,0x37 ,0x8B ,0xD8 ,0x0F ,0xB7 ,0x44 ,0x57 ,0x08 ,0x8B ,0xC8 ,0x81 ,0xE1
	,0x00 ,0xF0 ,0x00 ,0x00 ,0x66 ,0x3B ,0x4C ,0x24 ,0x1C ,0x74 ,0x07 ,0x66 ,0x3B ,0x4C ,0x24 ,0x0C ,0x75 ,0x12 ,0x8B ,0x4C ,0x24 ,0x2C ,0x25
	,0xFF ,0x0F ,0x00 ,0x00 ,0x03 ,0x07 ,0x01 ,0x0C ,0x30 ,0x8B ,0x74 ,0x24 ,0x10 ,0x42 ,0x3B ,0xD3 ,0x7C ,0xCE ,0x8B ,0x4F ,0x04 ,0x8B ,0x04
	,0x0F ,0x03 ,0xF9 ,0x8B ,0x4F ,0x04 ,0x03 ,0xC1 ,0x75 ,0xAD ,0x8B ,0x5D ,0x08 ,0x8B ,0x54 ,0x24 ,0x14 ,0x8B ,0x82 ,0x80 ,0x00 ,0x00 ,0x00
	,0x85 ,0xC0 ,0x0F ,0x84 ,0x61 ,0x01 ,0x00 ,0x00 ,0x8D ,0x0C ,0x30 ,0x8B ,0x01 ,0x89 ,0x4C ,0x24 ,0x18 ,0x85 ,0xC0 ,0x0F ,0x84 ,0x12 ,0x01
	,0x00 ,0x00 ,0x0F ,0x1F ,0x80 ,0x00 ,0x00 ,0x00 ,0x00 ,0x8B ,0x51 ,0x10 ,0x8D ,0x1C ,0x30 ,0x8B ,0x41 ,0x0C ,0x03 ,0xD6 ,0x03 ,0xC6 ,0x89
	,0x54 ,0x24 ,0x2C ,0x8B ,0x75 ,0x08 ,0x50 ,0x8D ,0x44 ,0x24 ,0x4C ,0x89 ,0x5C ,0x24 ,0x48 ,0x50 ,0x8B ,0x46 ,0x0C ,0xC7 ,0x44 ,0x24 ,0x14
	,0x00 ,0x00 ,0x00 ,0x00 ,0xFF ,0xD0 ,0x6A ,0x01 ,0x8D ,0x44 ,0x24 ,0x4C ,0x50 ,0x8D ,0x44 ,0x24 ,0x68 ,0x50 ,0x8B ,0x46 ,0x10 ,0xFF ,0xD0
	,0x8D ,0x44 ,0x24 ,0x0C ,0x50 ,0x8D ,0x44 ,0x24 ,0x64 ,0x50 ,0x8B ,0x46 ,0x08 ,0x6A ,0x00 ,0x6A ,0x00 ,0xFF ,0xD0 ,0x8D ,0x44 ,0x24 ,0x60
	,0x50 ,0x8B ,0x46 ,0x14 ,0xFF ,0xD0 ,0x8B ,0x4C ,0x24 ,0x0C ,0x85 ,0xC9 ,0x0F ,0x84 ,0xE0 ,0x00 ,0x00 ,0x00 ,0x8B ,0x03 ,0x33 ,0xFF ,0x85
	,0xC0 ,0x74 ,0x7E ,0x33 ,0xDB ,0x90 ,0xC7 ,0x44 ,0x24 ,0x1C ,0x00 ,0x00 ,0x00 ,0x00 ,0x85 ,0xC0 ,0x79 ,0x16 ,0x0F ,0xB7 ,0xC0 ,0x85 ,0xC0
	,0x0F ,0x84 ,0xBE ,0x00 ,0x00 ,0x00 ,0x8D ,0x54 ,0x24 ,0x1C ,0x52 ,0x50 ,0x6A ,0x00 ,0x51 ,0xEB ,0x2D ,0x8B ,0x74 ,0x24 ,0x10 ,0x83 ,0xC0
	,0x02 ,0x03 ,0xC6 ,0x0F ,0x84 ,0xA8 ,0x00 ,0x00 ,0x00 ,0x8B ,0x75 ,0x08 ,0x50 ,0x8D ,0x44 ,0x24 ,0x4C ,0x50 ,0x8B ,0x46 ,0x0C ,0xFF ,0xD0
	,0x8D ,0x44 ,0x24 ,0x1C ,0x50 ,0x6A ,0x00 ,0x8D ,0x44 ,0x24 ,0x50 ,0x50 ,0xFF ,0x74 ,0x24 ,0x18 ,0x8B ,0x06 ,0xFF ,0xD0 ,0x8B ,0x44 ,0x24
	,0x1C ,0x85 ,0xC0 ,0x74 ,0x7A ,0x8B ,0x4C ,0x24 ,0x2C ,0x47 ,0x89 ,0x04 ,0x0B ,0x8D ,0x1C ,0xBD ,0x00 ,0x00 ,0x00 ,0x00 ,0x8B ,0x44 ,0x24
	,0x44 ,0x8B ,0x04 ,0x03 ,0x85 ,0xC0 ,0x74 ,0x06 ,0x8B ,0x4C ,0x24 ,0x0C ,0xEB ,0x85 ,0x8B ,0x4C ,0x24 ,0x18 ,0x8B ,0x74 ,0x24 ,0x10 ,0x83
	,0xC1 ,0x14 ,0x89 ,0x4C ,0x24 ,0x18 ,0x8B ,0x01 ,0x85 ,0xC0 ,0x0F ,0x85 ,0xFC ,0xFE ,0xFF ,0xFF ,0x8B ,0x5D ,0x08 ,0x8B ,0x54 ,0x24 ,0x14
	,0x8B ,0x7A ,0x28 ,0x33 ,0xC0 ,0x03 ,0xFE ,0x39 ,0x42 ,0x54 ,0x76 ,0x10 ,0xC6 ,0x04 ,0x30 ,0xDD ,0x40 ,0x3B ,0x42 ,0x54 ,0x73 ,0x06 ,0x8B
	,0x74 ,0x24 ,0x10 ,0xEB ,0xF0 ,0xFF ,0x74 ,0x24 ,0x28 ,0x8B ,0x43 ,0x20 ,0x6A ,0xFF ,0xFF ,0xD0 ,0xFF ,0x74 ,0x24 ,0x30 ,0x8B ,0x43 ,0x30
	,0xFF ,0xD0 ,0xFF ,0x74 ,0x24 ,0x10 ,0x6A ,0x01 ,0x6A ,0x00 ,0xFF ,0xD7 ,0x8B ,0x74 ,0x24 ,0x10 ,0x8B ,0xC6 ,0x5F ,0x5E ,0x5B ,0x8B ,0xE5
	,0x5D ,0xC2 ,0x04 ,0x00
};
BOOLEAN g_InitLoadImage = FALSE;
UNICODE_STRING m_GlobalInjectDllPath64 = {0};
UNICODE_STRING m_GlobalInjectDllPath32 = {0};
ANSI_STRING    m_GlobalProcessName = {0};


BOOLEAN bOnce = FALSE;

PINJECT_BUFFER GetInlineHookCode64(IN HANDLE ProcessHandle, IN PUNICODE_STRING pDllPath)
{
	NTSTATUS status = STATUS_UNSUCCESSFUL;
	PINJECT_BUFFER pBuffer = NULL;
	INJECT_BUFFER Buffer = { 0 };

	//Try to allocate before ntdll.dll
	pBuffer = (PINJECT_BUFFER)AllocateInjectMemory(ProcessHandle, (PVOID)PsNtDllBase64, PAGE_SIZE);
	if (pBuffer != NULL)
	{
		//RtlCopyMemory(Buffer.original_code, fnHookFunc64, sizeof(Buffer.original_code));

		status = pfnZwReadVirtualMemory(ProcessHandle, fnHookFunc64, Buffer.original_code, sizeof(Buffer.original_code), NULL);
		
		if (NT_SUCCESS(status))
		{
			// Fill data
			Buffer.path.Length = min(pDllPath->Length, sizeof(Buffer.buffer));
			Buffer.path.MaximumLength = min(pDllPath->MaximumLength, sizeof(Buffer.buffer));
			Buffer.path.Buffer = (PWCH)pBuffer->buffer;
			Buffer.hook_func = fnHookFunc64;
			RtlCopyMemory(Buffer.buffer, pDllPath->Buffer, Buffer.path.Length);
			RtlCopyMemory(Buffer.code, HookCode64, sizeof(HookCode64));

			// Fill code
			*(ULONG*)((PUCHAR)Buffer.code + 16) = (ULONG)((ULONGLONG)&pBuffer->hook_func - ((ULONGLONG)pBuffer + 20));
			*(ULONG*)((PUCHAR)Buffer.code + 65) = (ULONG)((ULONGLONG)fnProtectVirtualMemory64 - ((ULONGLONG)pBuffer + 69));
			*(ULONG*)((PUCHAR)Buffer.code + 71) = (ULONG)((ULONGLONG)pBuffer->original_code - ((ULONGLONG)pBuffer + 75));
			*(ULONG*)((PUCHAR)Buffer.code + 83) = (ULONG)((ULONGLONG)&pBuffer->hook_func - ((ULONGLONG)pBuffer + 87));
			*(ULONG*)((PUCHAR)Buffer.code + 96) = (ULONG)((ULONGLONG)(pBuffer->original_code + 4) - ((ULONGLONG)pBuffer + 100));
			*(ULONG*)((PUCHAR)Buffer.code + 124) = (ULONG)((ULONGLONG)fnProtectVirtualMemory64 - ((ULONGLONG)pBuffer + 128));
			*(ULONG*)((PUCHAR)Buffer.code + 131) = (ULONG)((ULONGLONG)&pBuffer->module - ((ULONGLONG)pBuffer + 135));
			*(ULONG*)((PUCHAR)Buffer.code + 140) = (ULONG)((ULONGLONG)&pBuffer->path - ((ULONGLONG)pBuffer + 144));
			*(ULONG*)((PUCHAR)Buffer.code + 147) = (ULONG)((ULONGLONG)fnLdrLoadDll64 - ((ULONGLONG)pBuffer + 151));
			*(ULONG*)((PUCHAR)Buffer.code + 165) = (ULONG)((ULONGLONG)fnHookFunc64 - ((ULONGLONG)pBuffer + 169));

			//Write all
			//RtlCopyMemory(pBuffer, &Buffer, sizeof(Buffer.original_code));
			pfnZwWriteVirtualMemory(ProcessHandle, pBuffer, &Buffer, sizeof(Buffer), NULL);

			return pBuffer;
		}
		else
		{
			DbgPrint("%s: Failed to read original code %X\n", __FUNCTION__, status);
		}
	}
	else
	{
		DbgPrint("%s: Failed to allocate memory\n", __FUNCTION__);
	}
	return NULL;
}

PINJECT_BUFFER GetInlineHookCode32(IN HANDLE ProcessHandle, IN PUNICODE_STRING pDllPath)
{
	NTSTATUS status = STATUS_UNSUCCESSFUL;
	PINJECT_BUFFER pBuffer = NULL;
	INJECT_BUFFER Buffer = { 0 };
	//__debugbreak();

	//Try to allocate before ntdll.dll
	pBuffer = (PINJECT_BUFFER)AllocateInjectMemory(ProcessHandle, (PVOID)PsNtDllBase32, PAGE_SIZE);

	DbgPrint("(pBuffer.0x%x\r\n", pBuffer);
	if (pBuffer != NULL)
	{

		ULONG OldProtect = 0;
		PVOID ProtectAddress = fnHookFunc32;
		SIZE_T ProtectSize = sizeof(Buffer.original_code);
		status = pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, PAGE_EXECUTE_READWRITE, &OldProtect);
		if (NT_SUCCESS(status))
		{
			status = pfnZwReadVirtualMemory(ProcessHandle, fnHookFunc32, Buffer.original_code, sizeof(Buffer.original_code), NULL);
			DbgPrint("original_code:%s\r\n", Buffer.original_code);
			pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, OldProtect, &OldProtect);
		}

		if (NT_SUCCESS(status))
		{
			// Fill data
			Buffer.path32.Length = min(pDllPath->Length, sizeof(Buffer.buffer));
			Buffer.path32.MaximumLength = min(pDllPath->MaximumLength, sizeof(Buffer.buffer));
			Buffer.path32.Buffer = (ULONG)pBuffer->buffer;
			Buffer.hook_func = fnHookFunc32;
			memcpy(Buffer.buffer, pDllPath->Buffer, Buffer.path32.Length);
			memcpy(Buffer.code, HookCode32, sizeof(HookCode32));

			// Fill code
			*(DWORD*)((PUCHAR)Buffer.code + 7) = (DWORD)&pBuffer->hook_func;
			*(DWORD*)((PUCHAR)Buffer.code + 38) = (DWORD)((DWORD)fnProtectVirtualMemory32 - ((DWORD)pBuffer + 42));
			*(DWORD*)((PUCHAR)Buffer.code + 44) = (DWORD)&pBuffer->hook_func;
			*(DWORD*)((PUCHAR)Buffer.code + 49) = (DWORD)pBuffer->original_code;
			*(DWORD*)((PUCHAR)Buffer.code + 56) = (DWORD)pBuffer->original_code + 4;
			*(DWORD*)((PUCHAR)Buffer.code + 81) = (DWORD)((DWORD)fnProtectVirtualMemory32 - ((DWORD)pBuffer + 85));
			*(DWORD*)((PUCHAR)Buffer.code + 86) = (DWORD)&pBuffer->module;
			*(DWORD*)((PUCHAR)Buffer.code + 91) = (DWORD)(&pBuffer->path32);
			*(DWORD*)((PUCHAR)Buffer.code + 100) = (DWORD)((DWORD)fnLdrLoadDll32 - ((DWORD)pBuffer + 104));
			*(DWORD*)((PUCHAR)Buffer.code + 108) = (DWORD)((DWORD)fnHookFunc32 - ((DWORD)pBuffer + 112));
			DbgPrint("(Buffer.code:%s\r\n", Buffer.code);

			//Write all
			pfnZwWriteVirtualMemory(ProcessHandle, pBuffer, &Buffer, sizeof(Buffer), NULL);

			return pBuffer;
		}
		else
		{
			DbgPrint("%s: Failed to read original code %X\n", __FUNCTION__, status);
		}
	}
	else
	{
		DbgPrint("%s: Failed to allocate memory\n", __FUNCTION__);
	}
	return NULL;
}


PVOID AllocateInjectMemory(IN HANDLE ProcessHandle, IN PVOID DesiredAddress, IN SIZE_T DesiredSize)
{
	
	MEMORY_BASIC_INFORMATION mbi;
	SIZE_T AllocateSize = DesiredSize;
//	UNICODE_STRING uniFunctionName;
	if ((ULONG_PTR)DesiredAddress >= 0x70000000 && (ULONG_PTR)DesiredAddress < 0x80000000)
		DesiredAddress = (PVOID)0x70000000;
	NTSTATUS status = STATUS_SUCCESS;

	while (1)
	{
		status = ZwQueryVirtualMemory(ProcessHandle, DesiredAddress, MemoryBasicInformation, &mbi, sizeof(mbi), NULL);
		DbgPrint("status:0x%llx", status);
		if (!NT_SUCCESS(status))
			return NULL;

		if (DesiredAddress != mbi.AllocationBase)
		{
			DesiredAddress = mbi.AllocationBase;
		}
		else
		{
			DesiredAddress = (PVOID)((ULONG_PTR)mbi.AllocationBase - 0x10000);
		}

		if (mbi.State == MEM_FREE)// 在CE显示那份内存是 ？？ ？？ ?? ??
		{
			//往指定的进程 分配属于他自己的虚拟内存低2G的  在R0分配的内存 都是高2G
			if (NT_SUCCESS(ZwAllocateVirtualMemory(ProcessHandle, &mbi.BaseAddress, 0, &AllocateSize, MEM_RESERVE, PAGE_EXECUTE_READWRITE)))
			{
				if (NT_SUCCESS(ZwAllocateVirtualMemory(ProcessHandle, &mbi.BaseAddress, 0, &AllocateSize, MEM_COMMIT, PAGE_EXECUTE_READWRITE)))
				{
					return mbi.BaseAddress;
				}
			}
		}
	}
	return NULL;
}


NTSTATUS HideInjectByHook64(HANDLE ProcessId, PVOID ImageBase, PUNICODE_STRING pDllPath/*要注入的dll*/)
{

	ULONG ReturnLength;
	NTSTATUS status = STATUS_UNSUCCESSFUL;
	PEPROCESS Process = NULL;
	HANDLE ProcessHandle = NULL;

	if (!PsNtDllBase64)
		PsNtDllBase64 = ImageBase;

	PARAMX64 param = { 0 };
	status = PsLookupProcessByProcessId((HANDLE)ProcessId, &Process);
	if (NT_SUCCESS(status))
	{
		//Do not inject WOW64 process
		status = STATUS_UNSUCCESSFUL;
		if (PsGetProcessWow64Process(Process) == NULL)
		{
			status = ObOpenObjectByPointer(Process, OBJ_KERNEL_HANDLE, NULL, PROCESS_ALL_ACCESS, NULL, KernelMode, &ProcessHandle);
			if (NT_SUCCESS(status))
			{
				//	KAPC_STATE kApc;

				if (!fnLdrLoadDll64 || !fnHookFunc64 || !fnProtectVirtualMemory64)
				{
					fnProtectVirtualMemory64 = (PVOID)GetProcAddress(PsNtDllBase64, "ZwProtectVirtualMemory");//SearchModuleAndFindFuncAddrInTarget64(Process,"ZwProtectVirtualMemory");
					fnLdrLoadDll64 = (PVOID)GetProcAddress(PsNtDllBase64, "LdrLoadDll");//SearchModuleAndFindFuncAddrInTarget64(Process,"LdrLoadDll");
					fnHookFunc64 = (PVOID)GetProcAddress(PsNtDllBase64, "ZwTestAlert");//SearchModuleAndFindFuncAddrInTarget64(Process,"ZwTestAlert");
			
					param.LdrGetProcedureAddress = (ULONG64)GetProcAddress(PsNtDllBase64, "LdrGetProcedureAddress");;
					param.ZwAllocateVirtualMemory = (ULONG64)GetProcAddress(PsNtDllBase64, "NtAllocateVirtualMemory");
					param.LdrLoadDll = (ULONG64)GetProcAddress(PsNtDllBase64, "LdrLoadDll");
					param.RtlInitAnsiString = (ULONG64)GetProcAddress(PsNtDllBase64, "RtlInitAnsiString");
					param.RtlAnsiStringToUnicodeString = (ULONG64)GetProcAddress(PsNtDllBase64, "RtlAnsiStringToUnicodeString");
					param.RtlFreeUnicodeString = (ULONG64)GetProcAddress(PsNtDllBase64, "RtlFreeUnicodeString");
					param.ZwUnmapViewOfSection = (ULONG64)GetProcAddress(PsNtDllBase64, "ZwUnmapViewOfSection");
					param.ZwMapViewOfSection = (ULONG64)GetProcAddress(PsNtDllBase64, "ZwMapViewOfSection");
					param.ZwCreateSection = (ULONG64)GetProcAddress(PsNtDllBase64, "ZwCreateSection");
					param.ZwCreateFile = (ULONG64)GetProcAddress(PsNtDllBase64, "ZwCreateFile");
					param.RtlInitUnicodeString = (ULONG64)GetProcAddress(PsNtDllBase64, "RtlInitUnicodeString");
					param.ZwQueryInformationFile = (ULONG64)GetProcAddress(PsNtDllBase64, "ZwQueryInformationFile");
					param.ZwClose = (ULONG64)GetProcAddress(PsNtDllBase64, "ZwClose");
					param.bIsAddress = FALSE;
					RtlCopyMemory(param.szDllPath, pDllPath->Buffer, 240);
					
				}

				status = STATUS_UNSUCCESSFUL;

				if (fnLdrLoadDll64 && fnHookFunc64 && fnProtectVirtualMemory64)
				{
					PVOID pBuffer = AllocateInjectMemory(ProcessHandle, ImageBase,sizeof(HideCode64)+sizeof(PARAMX64));
					//不知道为什么pBuffer 会被刷走
					PVOID pTemp = (PVOID)((ULONG_PTR)pBuffer + sizeof(HideCode64));
					PVOID pTemp1 = pBuffer;
					if (pBuffer)
					{
						//ntdll.ZwTestAlert+8 - F6 04 25 0803FE7F 01          
						*(PULONG)&HideCode64[0x27+8] = (((ULONG_PTR)fnHookFunc64+9) - (((ULONG_PTR)pBuffer + 0x2f) + 5));
						//写入shellcode
						pfnZwWriteVirtualMemory(ProcessHandle, pBuffer, HideCode64, sizeof(HideCode64), &ReturnLength);
						//写入shellcode 参数
				
						pfnZwWriteVirtualMemory(ProcessHandle, pTemp, &param, sizeof(PARAMX64), &ReturnLength);


						

						UCHAR trampo[] = { 0xE9, 0, 0, 0, 0 };
						ULONG OldProtect = 0;
						PVOID ProtectAddress = fnHookFunc64;
						SIZE_T ProtectSize = sizeof(trampo);

						*(DWORD *)(trampo + 1) = (DWORD)((ULONG_PTR)pTemp1 - ((ULONG_PTR)fnHookFunc64 + 5));

						status = pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, PAGE_EXECUTE_READWRITE, &OldProtect);
						if (NT_SUCCESS(status))
						{
							pfnZwWriteVirtualMemory(ProcessHandle, fnHookFunc64, trampo, sizeof(trampo), &ReturnLength);
							pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, OldProtect, &OldProtect);
						}
					}
				}

				ZwClose(ProcessHandle);
			}
		}
		ObDereferenceObject(Process);
	}

	return status;
}



NTSTATUS HideInjectByHook32(HANDLE ProcessId, PVOID ImageBase, PUNICODE_STRING pDllPath/*要注入的dll*/)
{
	
	ULONG ReturnLength;
	NTSTATUS status = STATUS_UNSUCCESSFUL;
	PEPROCESS Process = NULL;
	HANDLE ProcessHandle = NULL;
	if (!PsNtDllBase32)
		PsNtDllBase32 = ImageBase;


	//	HANDLE process = NULL;

	PARAMX32 param = { 0 };
	status = PsLookupProcessByProcessId((HANDLE)ProcessId, &Process);
	if (NT_SUCCESS(status))
	{

		//Do not inject WOW64 process
		status = STATUS_UNSUCCESSFUL;
		if (PsGetProcessWow64Process(Process) != NULL)
		{
			//__debugbreak();
			DbgPrint("32 bit Process\r\n");
			status = ObOpenObjectByPointer(Process, OBJ_KERNEL_HANDLE, NULL, PROCESS_ALL_ACCESS, NULL, KernelMode, &ProcessHandle);
			if (NT_SUCCESS(status))
			{
				//	KAPC_STATE kApc;

				if (!fnLdrLoadDll32 || !fnHookFunc32 || !fnProtectVirtualMemory32)
				{
					
					fnProtectVirtualMemory32 = (PVOID)GetProcAddress(PsNtDllBase32, "ZwProtectVirtualMemory");//SearchModuleAndFindFuncAddrInTarget32(Process,L"ZwProtectVirtualMemory");
					fnLdrLoadDll32 = (PVOID)GetProcAddress(PsNtDllBase32, "LdrLoadDll");//SearchModuleAndFindFuncAddrInTarget32(Process, L"LdrLoadDll");
					fnHookFunc32 = (PVOID)GetProcAddress(PsNtDllBase32, "ZwTestAlert");//SearchModuleAndFindFuncAddrInTarget32(Process, L"ZwTestAlert");
					
					param.LdrGetProcedureAddress = (ULONG32)GetProcAddress(PsNtDllBase32, "LdrGetProcedureAddress");;
					param.ZwAllocateVirtualMemory = (ULONG32)GetProcAddress(PsNtDllBase32, "NtAllocateVirtualMemory");
					param.LdrLoadDll = (ULONG32)GetProcAddress(PsNtDllBase32, "LdrLoadDll");
					param.RtlInitAnsiString = (ULONG32)GetProcAddress(PsNtDllBase32, "RtlInitAnsiString");
					param.RtlAnsiStringToUnicodeString = (ULONG32)GetProcAddress(PsNtDllBase32, "RtlAnsiStringToUnicodeString");
					param.RtlFreeUnicodeString = (ULONG32)GetProcAddress(PsNtDllBase32, "RtlFreeUnicodeString");
					param.ZwUnmapViewOfSection = (ULONG32)GetProcAddress(PsNtDllBase32, "ZwUnmapViewOfSection");
					param.ZwMapViewOfSection = (ULONG32)GetProcAddress(PsNtDllBase32, "ZwMapViewOfSection");
					param.ZwCreateSection = (ULONG32)GetProcAddress(PsNtDllBase32, "ZwCreateSection");
					param.ZwCreateFile = (ULONG32)GetProcAddress(PsNtDllBase32, "ZwCreateFile");
					param.RtlInitUnicodeString = (ULONG32)GetProcAddress(PsNtDllBase32, "RtlInitUnicodeString");
					param.ZwQueryInformationFile = (ULONG32)GetProcAddress(PsNtDllBase32, "ZwQueryInformationFile");
					param.ZwClose = (ULONG32)GetProcAddress(PsNtDllBase32, "ZwClose");
					param.bIsAddress = TRUE;
					RtlCopyMemory(param.szDllPath, pDllPath->Buffer, 240);
				}

				status = STATUS_UNSUCCESSFUL;

				if (fnLdrLoadDll32 && fnHookFunc32 && fnProtectVirtualMemory32)
				{
					PVOID pBuffer = AllocateInjectMemory(ProcessHandle, ImageBase, sizeof(HideCode32) + sizeof(PARAMX32));
					if (pBuffer)
					{

						*(PULONG)&HideCode32[3] = (ULONG)pBuffer;

						//E9后面的地址 = 目标地址 - 当前地址 - 5
						*(PULONG)&HideCode32[0x1a] = ((ULONG_PTR)fnHookFunc32+5+1) - ((ULONG_PTR)pBuffer + 0x1a) - 5;
						//写入shellcode
						pfnZwWriteVirtualMemory(ProcessHandle, pBuffer, HideCode32, sizeof(HideCode32), &ReturnLength);
						//写入shellcode 参数
						pfnZwWriteVirtualMemory(ProcessHandle, ((ULONG_PTR)pBuffer + sizeof(HideCode32)), &param, sizeof(PARAMX32), &ReturnLength);


						UCHAR trampo[] = { 0xe9, 0, 0, 0, 0 };
						ULONG OldProtect = 0;
						PVOID ProtectAddress = fnHookFunc32;
						SIZE_T ProtectSize = sizeof(trampo);

						*(DWORD *)(trampo + 1) = (DWORD)((ULONG_PTR)pBuffer - ((ULONG_PTR)fnHookFunc32 + 5));

						status = pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, PAGE_EXECUTE_READWRITE, &OldProtect);
						if (NT_SUCCESS(status))
						{
							pfnZwWriteVirtualMemory(ProcessHandle, fnHookFunc32, trampo, sizeof(trampo), &ReturnLength);
							pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, OldProtect, &OldProtect);
						}
					}
				}

				ZwClose(ProcessHandle);
			}
		}
		ObDereferenceObject(Process);
	}

	return status;
}





NTSTATUS InjectByHook64(HANDLE ProcessId, PVOID ImageBase, PUNICODE_STRING pDllPath/*要注入的dll*/)
{
	//__debugbreak();
	ULONG ReturnLength;
	NTSTATUS status = STATUS_UNSUCCESSFUL;
	PEPROCESS Process = NULL;
	HANDLE ProcessHandle = NULL;

	if (!PsNtDllBase64)
		PsNtDllBase64 = ImageBase;


	status = PsLookupProcessByProcessId((HANDLE)ProcessId, &Process);
	if (NT_SUCCESS(status))
	{
		//Do not inject WOW64 process
		status = STATUS_UNSUCCESSFUL;
		if (PsGetProcessWow64Process(Process) == NULL)
		{
			status = ObOpenObjectByPointer(Process, OBJ_KERNEL_HANDLE, NULL, PROCESS_ALL_ACCESS, NULL, KernelMode, &ProcessHandle);
			if (NT_SUCCESS(status))
			{
			//	KAPC_STATE kApc;

				if (!fnLdrLoadDll64 || !fnHookFunc64 || !fnProtectVirtualMemory64)
				{
					//KeStackAttachProcess(Process, &kApc);
					fnProtectVirtualMemory64 = (PVOID)GetProcAddress(PsNtDllBase64,"ZwProtectVirtualMemory");//SearchModuleAndFindFuncAddrInTarget64(Process,"ZwProtectVirtualMemory");
					fnLdrLoadDll64 = (PVOID)GetProcAddress(PsNtDllBase64,"LdrLoadDll");//SearchModuleAndFindFuncAddrInTarget64(Process,"LdrLoadDll");
					fnHookFunc64 = (PVOID)GetProcAddress(PsNtDllBase64,"ZwTestAlert");//SearchModuleAndFindFuncAddrInTarget64(Process,"ZwTestAlert");
					//KeUnstackDetachProcess(&kApc);
					DbgPrint("ZwProtectVirtualMemory addr:0x%x LdrLoadDll:0x%x ZwTestAlert:0x%x\r\n", fnProtectVirtualMemory64, fnLdrLoadDll64, fnHookFunc64);
				}

				status = STATUS_UNSUCCESSFUL;

				if (fnLdrLoadDll64 && fnHookFunc64 && fnProtectVirtualMemory64)
				{
					PINJECT_BUFFER pBuffer = GetInlineHookCode64(ProcessHandle, pDllPath);
					if (pBuffer)
					{
						
						UCHAR trampo[] = { 0xE9, 0, 0, 0, 0 };
						ULONG OldProtect = 0;
						PVOID ProtectAddress = fnHookFunc64;
						SIZE_T ProtectSize = sizeof(trampo);

						*(DWORD *)(trampo + 1) = (DWORD)((ULONG_PTR)pBuffer->code - ((ULONG_PTR)fnHookFunc64 + 5));

						status = pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, PAGE_EXECUTE_READWRITE, &OldProtect);
						if (NT_SUCCESS(status))
						{
							pfnZwWriteVirtualMemory(ProcessHandle, fnHookFunc64, trampo, sizeof(trampo), &ReturnLength);
							pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, OldProtect, &OldProtect);
						}
					}
				}

				ZwClose(ProcessHandle);
			}
		}
		ObDereferenceObject(Process);
	}

	return status;
}



NTSTATUS InjectByHook32(HANDLE ProcessId, PVOID ImageBase, PUNICODE_STRING pDllPath/*要注入的dll*/)
{


	ULONG ReturnLength;
	NTSTATUS status = STATUS_UNSUCCESSFUL;
	PEPROCESS Process = NULL;
	HANDLE ProcessHandle = NULL;
	if (!PsNtDllBase32)
		PsNtDllBase32 = ImageBase;


//	HANDLE process = NULL;


	status = PsLookupProcessByProcessId((HANDLE)ProcessId, &Process);
	if (NT_SUCCESS(status))
	{

		//Do not inject WOW64 process
		status = STATUS_UNSUCCESSFUL;
		if (PsGetProcessWow64Process(Process) != NULL)
		{
			//__debugbreak();
			DbgPrint("32 bit Process\r\n");
			status = ObOpenObjectByPointer(Process, OBJ_KERNEL_HANDLE, NULL, PROCESS_ALL_ACCESS, NULL, KernelMode, &ProcessHandle);
			if (NT_SUCCESS(status))
			{
			//	KAPC_STATE kApc;

				if (!fnLdrLoadDll32 || !fnHookFunc32 || !fnProtectVirtualMemory32)
				{
					//KeStackAttachProcess(Process, &kApc); //回调 都不能使用 KeStackAttachProcess
					fnProtectVirtualMemory32 = (PVOID)GetProcAddress(PsNtDllBase32,"ZwProtectVirtualMemory");//SearchModuleAndFindFuncAddrInTarget32(Process,L"ZwProtectVirtualMemory");
					fnLdrLoadDll32 = (PVOID)GetProcAddress(PsNtDllBase32,"LdrLoadDll");//SearchModuleAndFindFuncAddrInTarget32(Process, L"LdrLoadDll");
					fnHookFunc32 = (PVOID)GetProcAddress(PsNtDllBase32,"ZwTestAlert");//SearchModuleAndFindFuncAddrInTarget32(Process, L"ZwTestAlert");
					DbgPrint("ZwProtectVirtualMemory addr:0x%x LdrLoadDll:0x%x ZwTestAlert:0x%x\r\n", fnProtectVirtualMemory32, fnLdrLoadDll32, fnHookFunc32);
					//KeUnstackDetachProcess(&kApc);
				}

				status = STATUS_UNSUCCESSFUL;

				if (fnLdrLoadDll32 && fnHookFunc32 && fnProtectVirtualMemory32)
				{
					PINJECT_BUFFER pBuffer = GetInlineHookCode32(ProcessHandle, pDllPath);



					if (pBuffer)
					{
						UCHAR trampo[] = { 0xe9, 0, 0, 0, 0 };
						ULONG OldProtect = 0;
						PVOID ProtectAddress = fnHookFunc32;
						SIZE_T ProtectSize = sizeof(trampo);

						*(DWORD *)(trampo + 1) = (DWORD)((ULONG_PTR)pBuffer->code - ((ULONG_PTR)fnHookFunc32 + 5));

						status = pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, PAGE_EXECUTE_READWRITE, &OldProtect);
						if (NT_SUCCESS(status))
						{
							pfnZwWriteVirtualMemory(ProcessHandle, fnHookFunc32, trampo, sizeof(trampo), &ReturnLength);
							pfnZwProtectVirtualMemory(ProcessHandle, &ProtectAddress, &ProtectSize, OldProtect, &OldProtect);
						}
					}
				}

				ZwClose(ProcessHandle);
			}
		}
		ObDereferenceObject(Process);
	}

	return status;
}


VOID LoadImageNotifyCallback(PUNICODE_STRING FullImageName, HANDLE ProcessId, PIMAGE_INFO pImageInfo)
{
	PEPROCESS Process;

	if (ProcessId == (HANDLE)0 || ProcessId == (HANDLE)4 || !MmIsAddressValid(m_GlobalProcessName.Buffer) || m_GlobalProcessName.Length==0)
		return;

	if (!FullImageName || !FullImageName->Length)
		return;

	if (pImageInfo->SystemModeImage)
		return;

	if (NT_SUCCESS(PsLookupProcessByProcessId(ProcessId, &Process)))
	{

		PCHAR ProcessName = (PCHAR)PsGetProcessImageFileName(Process);



		if (ProcessName && !strcmp(ProcessName, m_GlobalProcessName.Buffer))
		{

			if ((0 == _wcsnicmp(GetPathW(FullImageName->Buffer, L'\\', 2), L"\\System32\\ntdll.dll", sizeof("\\System32\\ntdll.dll") * 2)) && !PsGetProcessWow64Process(Process))
			{

				
				if (m_GlobalInjectDllPath64.Length != 0 && MmIsAddressValid(m_GlobalInjectDllPath64.Buffer))
				{
					__try
					{

						if (!g_bHideInject) 
						{
							InjectByHook64(ProcessId, pImageInfo->ImageBase, &m_GlobalInjectDllPath64);
						}
						else 
						{
							HideInjectByHook64(ProcessId, pImageInfo->ImageBase, &m_GlobalInjectDllPath64);
						}

					}
					__except (1)
					{

					}
				}


				return;
			}


			if ((0 == _wcsnicmp(GetPathW(FullImageName->Buffer, L'\\', 2), L"\\SysWOW64\\ntdll.dll", sizeof("\\SysWOW64\\ntdll.dll") * 2)) && PsGetProcessWow64Process(Process))
			{

				if (m_GlobalInjectDllPath32.Length != 0 && MmIsAddressValid(m_GlobalInjectDllPath32.Buffer))
				{
					__try
					{
						if (!g_bHideInject) {
							InjectByHook32(ProcessId, pImageInfo->ImageBase, &m_GlobalInjectDllPath32);
						}
						else 
						{
							HideInjectByHook32(ProcessId, pImageInfo->ImageBase, &m_GlobalInjectDllPath32);
						}
						
					}
					__except (1)
					{

					}

				}

				return;
			}

		}


		ObDereferenceObject(Process);
	}

}
